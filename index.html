<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶ñ‡¶æ‡¶§‡¶æ - ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>
    
    <!-- html2canvas for image export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --fb-blue: #1877F2;
            --fb-bg: #F0F2F5;
            --fb-white: #FFFFFF;
            --fb-gray: #65676B;
            --fb-border: #CED0D4;
            --success: #42b72a;
            --danger: #f02849;
            --bkash-color: #D12053;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--fb-bg);
            color: #1c1e21;
        }

        header {
            background-color: var(--fb-blue);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            background: var(--fb-white);
            border-bottom: 1px solid var(--fb-border);
            position: sticky;
            top: 48px;
            z-index: 999;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            cursor: pointer;
            color: var(--fb-gray);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            font-size: 14px;
        }

        .nav-tab.active {
            color: var(--fb-blue);
            border-bottom-color: var(--fb-blue);
        }

        .container {
            padding: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--fb-white);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        h2 { font-size: 1.1rem; margin: 0 0 12px 0; color: #1c1e21; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--fb-border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 15px;
            outline: none;
        }

        button {
            background-color: var(--fb-blue);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-add { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); padding: 5px 10px; width: auto; font-size: 12px; margin: 0; }

        .hidden { display: none; }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f2f5;
        }
        .list-item:last-child { border-bottom: none; }
        
        .bkash-item {
            background-color: #fff0f5;
            padding: 10px;
            margin: 4px -10px;
            border-radius: 8px;
            border-left: 4px solid var(--bkash-color);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .bg-cash { background: #e7f3ff; color: #1877f2; }
        .bg-credit { background: #ffebe9; color: #f02849; }
        .bg-bkash { background: #fff0f5; color: #D12053; }
        .bg-total { background: #eafbea; color: #2b7d2b; grid-column: span 2; }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 14px;
            text-align: center;
            animation: slideUp 0.3s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #memo-export-area {
            background: #fff;
            padding: 40px 30px;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            color: #000;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }
        .memo-header { text-align: center; margin-bottom: 20px; }
        .memo-title { font-size: 28px; font-weight: bold; margin: 0; }
        .memo-sub { font-size: 14px; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .memo-meta { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; }
        .memo-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; flex-grow: 1; }
        .memo-table th { background: #f2f2f2; border: 1px solid #000; padding: 8px; text-align: left; }
        .memo-table td { border: 1px solid #000; padding: 8px; }
        .memo-total-section { border-top: 2px solid #000; padding-top: 10px; text-align: right; }
        .grand-total { font-size: 20px; font-weight: bold; }
        .memo-signatures { margin-top: 60px; display: flex; justify-content: space-between; }
        .sig-box { border-top: 1px solid #000; width: 150px; text-align: center; padding-top: 5px; font-size: 13px; }

        .added-items-list { margin: 10px 0; font-size: 13px; background: #f9f9f9; padding: 10px; border-radius: 6px; }
        .added-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee; }
        
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .badge-cash { background: #e7f3ff; color: #1877f2; }
        .badge-credit { background: #ffebe9; color: #f02849; }

        .total-input-group {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--fb-blue);
        }
        .total-input-group label {
            display: block;
            font-size: 12px;
            color: var(--fb-blue);
            font-weight: bold;
            margin-bottom: 4px;
        }
        #sale-total-input {
            background: #fff;
            border: 2px solid var(--fb-blue);
            font-size: 20px;
            font-weight: bold;
            color: #1877f2;
            text-align: center;
        }

        /* Modal for Confirmation */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 85%;
            max-width: 350px;
            text-align: center;
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.1rem;">üõí ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶ñ‡¶æ‡¶§‡¶æ</div>
    <div id="conn-status" style="font-size: 10px; background: var(--success); padding: 2px 8px; border-radius: 12px; color: white;">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</div>
</header>

<!-- Toast Container -->
<div id="toast-container"></div>

<div class="nav-tabs">
    <div class="nav-tab active" id="tab-btn-stock" onclick="showTab('stock')">‡¶∏‡ßç‡¶ü‡¶ï</div>
    <div class="nav-tab" id="tab-btn-sales" onclick="showTab('sales')">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</div>
    <div class="nav-tab" id="tab-btn-history" onclick="showTab('history')">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ñ‡¶æ‡¶§‡¶æ</div>
    <div class="nav-tab" id="tab-btn-memo" onclick="showTab('memo')">‡¶Æ‡ßá‡¶Æ‡ßã</div>
</div>

<div class="container">
    <!-- Stock Tab -->
    <div id="tab-stock" class="tab-content">
        <div class="card">
            <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <input type="text" id="p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="number" id="p-price" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)">
            <button class="btn-add" onclick="saveProduct()">‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        <div class="card">
            <h2>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
            <div id="inventory-list">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        </div>
    </div>

    <!-- Sales Tab -->
    <div id="tab-sales" class="tab-content hidden">
        <div class="card">
            <h2>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
            <select id="sale-prod-select" onchange="onProductSelectChange()">
                <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
            </select>
            <div style="display: flex; gap: 8px;">
                <input type="number" id="sale-qty" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" oninput="calculateSaleTotal()">
                <input type="number" id="sale-price" placeholder="‡¶¶‡¶æ‡¶Æ (‡ß≥)" oninput="calculateSaleTotal()">
            </div>
            <input type="text" id="cust-name-entry" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶π‡¶≤‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶®)">
            
            <div class="total-input-group">
                <label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ (‡¶è‡¶ü‡¶ø ‡¶á‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá)</label>
                <input type="number" id="sale-total-input" placeholder="‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ">
            </div>

            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button onclick="recordTransaction('cash')" style="background-color: var(--success); flex: 1;">‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</button>
                <button onclick="recordTransaction('credit')" style="background-color: var(--danger); flex: 1;">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</button>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="tab-content hidden">
        <div class="summary-grid">
            <div class="summary-card bg-cash">
                <div style="font-size: 12px;">‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡¶Æ‡¶æ‡¶≤)</div>
                <div id="stat-cash" style="font-weight: bold; font-size: 18px;">‡ß¶ ‡ß≥</div>
            </div>
            <div class="summary-card bg-credit">
                <div style="font-size: 12px;">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</div>
                <div id="stat-credit" style="font-weight: bold; font-size: 18px;">‡ß¶ ‡ß≥</div>
            </div>
            <div class="summary-card bg-bkash" style="grid-column: span 2; margin-top: 0px;">
                <div style="font-size: 14px;">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: <span id="stat-bkash" style="font-weight: bold;">‡ß¶ ‡ß≥</span></div>
            </div>
            <div class="summary-card bg-total">
                <div style="font-size: 14px;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: <span id="stat-total" style="font-weight: bold;">‡ß¶ ‡ß≥</span></div>
            </div>
        </div>
        <div class="card" id="history-export-area">
            <h2>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h2>
            <div id="history-list">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>
        </div>
        <button onclick="exportAsImage('history-export-area', '‡¶π‡¶ø‡¶∏‡¶æ‡¶¨-‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡ßÄ')" style="background-color: #65676B; margin-top: 10px;">
            üì∑ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>

    <!-- Independent Memo Tab -->
    <div id="tab-memo" class="tab-content hidden">
        <div class="card">
            <h2>‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ ‡¶ì ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h2>
            <input type="text" id="m-cust-name" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" oninput="updateMemoUI()">
            <input type="text" id="m-seller-name" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ / ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" oninput="updateMemoUI()">
            <input type="text" id="m-date" placeholder="‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ" oninput="updateMemoUI()">
        </div>

        <div class="card">
            <h2>‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</h2>
            <input type="text" id="m-item-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <div style="display: flex; gap: 8px;">
                <input type="number" id="m-item-qty" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                <input type="number" id="m-item-rate" placeholder="‡¶¶‡¶∞ (‡ß≥)">
            </div>
            <button class="btn-add" onclick="addMemoItem()">+ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <div id="added-items-container" class="added-items-list">
                <i>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</i>
            </div>
        </div>

        <div class="card">
            <select id="m-pay-type" onchange="updateMemoUI()">
                <option value="‡¶®‡¶ó‡¶¶">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ‡¶®‡¶ó‡¶¶</option>
                <option value="‡¶¨‡¶æ‡¶ï‡¶ø">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ‡¶¨‡¶æ‡¶ï‡¶ø</option>
            </select>
        </div>

        <!-- Memo Preview Area -->
        <div id="memo-export-area">
            <div class="memo-header">
                <div class="memo-title">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã</div>
                <div class="memo-sub">‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶ï‡¶™‡¶ø</div>
            </div>

            <div class="memo-meta">
                <div>
                    <div>‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ: <b id="p-cust">--</b></div>
                    <div>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: <span id="p-type">‡¶®‡¶ó‡¶¶</span></div>
                </div>
                <div style="text-align: right;">
                    <div>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="p-date">--</span></div>
                    <div>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç: <span id="p-id">#0000</span></div>
                </div>
            </div>

            <table class="memo-table">
                <thead>
                    <tr>
                        <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                        <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                        <th>‡¶¶‡¶∞</th>
                        <th style="text-align: right;">‡¶Æ‡ßã‡¶ü</th>
                    </tr>
                </thead>
                <tbody id="p-items-table">
                    <!-- Products appear here -->
                </tbody>
            </table>

            <div class="memo-total-section">
                <div class="grand-total">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü: <span id="p-grand-total">‡ß¶</span> ‡ß≥</div>
            </div>

            <div class="memo-signatures">
                <div class="sig-box">‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                <div class="sig-box">
                    <span id="p-seller-display">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</span><br>
                    <small>(‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞)</small>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; font-size: 12px; font-style: italic;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶®!</div>
        </div>

        <button onclick="exportAsImage('memo-export-area', '‡¶Æ‡ßá‡¶Æ‡ßã')" style="background-color: var(--success); margin-top: 20px;">
            üì∑ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶õ‡¶¨‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
        authDomain: "exchange-project-d4028.firebaseapp.com",
        databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exchange-project-d4028",
        storageBucket: "exchange-project-d4028.firebasestorage.app",
        messagingSenderId: "313976742479",
        appId: "1:313976742479:web:45951b360d875c4768c03a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'grocery-hisab-final';

    let inventoryData = {};
    let transactionData = {};
    let memoProducts = []; 

    const invPath = `artifacts/${appId}/public/data/inventory`;
    const transPath = `artifacts/${appId}/public/data/transactions`;

    // --- Toast Logic ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerText = message;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // --- Custom Confirm Logic ---
    function customConfirm(message, callback) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
            <div class="modal-content">
                <p style="margin-bottom: 20px;">${message}</p>
                <div style="display: flex; gap: 10px;">
                    <button onclick="this.closest('.modal-overlay').remove()" style="background:#65676B;">‡¶®‡¶æ</button>
                    <button id="modal-confirm-btn" style="background:var(--danger);">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        document.getElementById('modal-confirm-btn').onclick = () => {
            overlay.remove();
            callback();
        };
    }

    auth.signInAnonymously().catch(err => {
        showToast("‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message, 'error');
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            setupRealtimeListeners();
            initMemoTab();
        }
    });

    function setupRealtimeListeners() {
        db.ref(invPath).on('value', snapshot => {
            inventoryData = snapshot.val() || {};
            renderInventory();
            updateSalesDropdown();
        }, err => {
            showToast("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message, 'error');
        });

        db.ref(transPath).on('value', snapshot => {
            transactionData = snapshot.val() || {};
            renderHistory();
        }, err => {
            showToast("‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message, 'error');
        });
    }

    // --- Stock Functions ---
    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        if (!name || !price) {
            showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", 'error');
            return;
        }

        db.ref(invPath).push({
            name: name,
            price: parseFloat(price),
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }).catch(err => {
            showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: " + err.message, 'error');
        });
    }

    function deleteProduct(id) {
        customConfirm("‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶§‡ßç‡¶Ø‡¶ø‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?", () => {
            db.ref(`${invPath}/${id}`).remove()
                .then(() => showToast("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"))
                .catch(err => showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", 'error'));
        });
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        const keys = Object.keys(inventoryData).reverse();
        if (keys.length === 0) list.innerHTML = "‡¶∏‡ßç‡¶ü‡¶ï ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§";

        keys.forEach(key => {
            const item = inventoryData[key];
            list.innerHTML += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="font-size:12px; color:var(--fb-gray);">‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${item.price} ‡ß≥</div>
                    </div>
                    <button class="btn-danger" onclick="deleteProduct('${key}')">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
                </div>`;
        });
    }

    // --- Sales Functions ---
    function updateSalesDropdown() {
        const select = document.getElementById('sale-prod-select');
        select.innerHTML = `
            <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
            <option value="hardcoded_bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
            <option value="hardcoded_nagad">‡¶®‡¶ó‡¶¶ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)</option>
        `;
        Object.keys(inventoryData).forEach(key => {
            select.innerHTML += `<option value="${key}">${inventoryData[key].name}</option>`;
        });
    }

    function onProductSelectChange() {
        const prodId = document.getElementById('sale-prod-select').value;
        
        if (prodId === 'hardcoded_bkash' || prodId === 'hardcoded_nagad') {
            document.getElementById('sale-qty').value = "1";
            document.getElementById('sale-price').value = "";
            document.getElementById('sale-total-input').value = "";
            return;
        }

        if (prodId && inventoryData[prodId]) {
            document.getElementById('sale-price').value = inventoryData[prodId].price;
            document.getElementById('sale-qty').value = ""; 
            calculateSaleTotal();
        }
    }

    function calculateSaleTotal() {
        const qty = parseFloat(document.getElementById('sale-qty').value) || 0;
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        const total = qty * price;
        document.getElementById('sale-total-input').value = total;
    }

    function recordTransaction(type) {
        const prodId = document.getElementById('sale-prod-select').value;
        const qty = document.getElementById('sale-qty').value;
        const price = document.getElementById('sale-price').value;
        const customer = document.getElementById('cust-name-entry').value;
        const finalTotal = parseFloat(document.getElementById('sale-total-input').value) || 0;

        if (!prodId || !qty || !price) {
            showToast("‡¶™‡¶£‡ßç‡¶Ø, ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶æ‡¶Æ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®‡•§", 'error');
            return;
        }
        if (type === 'credit' && !customer) {
            showToast("‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶®‡•§", 'error');
            return;
        }

        let productName = "";
        if (prodId === 'hardcoded_bkash') productName = "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂";
        else if (prodId === 'hardcoded_nagad') productName = "‡¶®‡¶ó‡¶¶ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)";
        else productName = inventoryData[prodId].name;

        db.ref(transPath).push({
            itemName: productName,
            qty: qty,
            price: parseFloat(price),
            total: finalTotal, 
            type: type,
            buyer: customer || "‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü",
            date: new Date().toLocaleDateString('bn-BD'),
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('sale-qty').value = '';
            document.getElementById('sale-price').value = '';
            document.getElementById('cust-name-entry').value = '';
            document.getElementById('sale-total-input').value = '';
            document.getElementById('sale-prod-select').value = '';
            showToast("‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            showTab('history');
        }).catch(err => {
            showToast("‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message, 'error');
        });
    }

    // --- History Functions ---
    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const allKeys = Object.keys(transactionData);
        
        const bkashKeys = allKeys.filter(key => transactionData[key].itemName === '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂')
                                 .sort((a, b) => transactionData[b].timestamp - transactionData[a].timestamp);
        const otherKeys = allKeys.filter(key => transactionData[key].itemName !== '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂')
                                 .sort((a, b) => transactionData[b].timestamp - transactionData[a].timestamp);
        
        const sortedKeys = [...bkashKeys, ...otherKeys];
        
        let totalCash = 0;
        let totalCredit = 0;
        let totalBkash = 0;

        if (sortedKeys.length === 0) {
            list.innerHTML = "‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        } else {
            sortedKeys.forEach(key => {
                const t = transactionData[key];
                const isBkash = t.itemName === '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂';
                const isBankingNagad = t.itemName === '‡¶®‡¶ó‡¶¶ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)';

                if (isBkash) {
                    totalBkash += t.total;
                } else if (isBankingNagad) {
                    if (t.type === 'cash') totalCash += t.total; else totalCredit += t.total;
                } else {
                    if (t.type === 'cash') totalCash += t.total; else totalCredit += t.total;
                }
                
                const badgeClass = t.type === 'cash' ? 'badge-cash' : 'badge-credit';
                const typeText = t.type === 'cash' ? '‡¶®‡¶ó‡¶¶' : '‡¶¨‡¶æ‡¶ï‡¶ø';

                list.innerHTML += `
                    <div class="list-item ${isBkash ? 'bkash-item' : ''}">
                        <div style="flex: 2;">
                            <div style="font-weight: bold; ${isBkash ? 'color: var(--bkash-color);' : ''}">
                                ${t.itemName} <small>(${t.qty} x ${t.price}‡ß≥)</small>
                            </div>
                            <div style="font-size: 11px; color: var(--fb-gray);">${t.buyer} | ${t.date}</div>
                        </div>
                        <div style="text-align: right; flex: 1;">
                            <div style="font-weight: bold; color: #333;">${t.total} ‡ß≥</div>
                            <span class="badge ${badgeClass}">${typeText}</span>
                        </div>
                    </div>`;
            });
        }

        document.getElementById('stat-cash').innerText = totalCash + " ‡ß≥";
        document.getElementById('stat-credit').innerText = totalCredit + " ‡ß≥";
        document.getElementById('stat-bkash').innerText = totalBkash + " ‡ß≥"; 
        document.getElementById('stat-total').innerText = (totalCash + totalCredit + totalBkash) + " ‡ß≥";
    }

    // --- Independent Memo Tab Logic ---
    function initMemoTab() {
        document.getElementById('m-date').value = new Date().toLocaleDateString('bn-BD');
        document.getElementById('p-id').innerText = "#" + Math.floor(1000 + Math.random() * 9000);
        updateMemoUI();
    }

    function addMemoItem() {
        const name = document.getElementById('m-item-name').value;
        const qty = parseFloat(document.getElementById('m-item-qty').value);
        const rate = parseFloat(document.getElementById('m-item-rate').value);

        if (!name || isNaN(qty) || isNaN(rate)) {
            showToast("‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü", 'error');
            return;
        }

        memoProducts.push({
            id: Date.now(),
            name, qty, rate, total: qty * rate
        });

        document.getElementById('m-item-name').value = '';
        document.getElementById('m-item-qty').value = '';
        document.getElementById('m-item-rate').value = '';
        updateMemoUI();
        showToast("‡¶Æ‡ßá‡¶Æ‡ßã‡¶§‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá");
    }

    function removeMemoItem(id) {
        memoProducts = memoProducts.filter(i => i.id !== id);
        updateMemoUI();
        showToast("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
    }

    function updateMemoUI() {
        document.getElementById('p-cust').innerText = document.getElementById('m-cust-name').value || '--';
        document.getElementById('p-seller-display').innerText = document.getElementById('m-seller-name').value || '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ';
        document.getElementById('p-date').innerText = document.getElementById('m-date').value || '--';
        document.getElementById('p-type').innerText = document.getElementById('m-pay-type').value;

        const listContainer = document.getElementById('added-items-container');
        listContainer.innerHTML = memoProducts.length ? memoProducts.map(i => `
            <div class="added-item">
                <span>${i.name} (${i.qty} x ${i.rate}‡ß≥)</span>
                <button class="btn-danger" onclick="removeMemoItem(${i.id})">‡¶¨‡¶æ‡¶¶</button>
            </div>`).join('') : '<i>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</i>';

        const tableBody = document.getElementById('p-items-table');
        tableBody.innerHTML = memoProducts.map(i => `
            <tr>
                <td>${i.name}</td>
                <td>${i.qty}</td>
                <td>${i.rate}</td>
                <td style="text-align: right;">${i.total} ‡ß≥</td>
            </tr>`).join('');

        const grandTotal = memoProducts.reduce((sum, i) => sum + i.total, 0);
        document.getElementById('p-grand-total').innerText = grandTotal;
    }

    // --- Navigation ---
    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.getElementById('tab-btn-' + tab).classList.add('active');
    }

    // --- Export Function ---
    function exportAsImage(divId, fileName) {
        const element = document.getElementById(divId);
        showToast("‡¶õ‡¶¨‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...");
        
        html2canvas(element, { backgroundColor: "#FFFFFF", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = fileName + '-' + Date.now() + '.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
            showToast("‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }).catch(err => {
            showToast("‡¶õ‡¶¨‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + err.message, 'error');
        });
    }
</script>

</body>
</html>

