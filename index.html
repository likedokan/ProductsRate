<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶ñ‡¶æ‡¶§‡¶æ - ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg-main: #f1f5f9;
            --white: #ffffff;
            --text-dark: #0f172a;
            --text-gray: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --danger: #ef4444;
            --banking: #db2777;
            --card-radius: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-main);
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        header {
            background: linear-gradient(135deg, var(--primary), #312e81);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .status-badge {
            font-size: 10px;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 64px;
            z-index: 999;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 16px 0;
            cursor: pointer;
            color: var(--text-gray);
            font-weight: 700;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #f8fafc;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.5);
        }

        h2 { font-size: 1.25rem; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; }

        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: var(--primary-light);
            background: white;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        label { font-size: 13px; font-weight: 700; color: var(--text-gray); margin-left: 4px; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #475569; color: white; }
        
        .btn:active { transform: scale(0.97); opacity: 0.9; }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 24px;
        }

        .summary-card {
            padding: 20px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .bg-sale { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-bank { background: linear-gradient(135deg, #db2777, #9d174d); }
        .bg-info { background: linear-gradient(135deg, #6366f1, #4338ca); grid-column: span 2; }

        .summary-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; }
        .summary-value { font-size: 24px; font-weight: 900; margin-top: 6px; }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .item-info b { font-size: 16px; color: var(--text-dark); display: block; }
        .item-info span { font-size: 12px; color: var(--text-gray); }

        .item-amount { text-align: right; }
        .item-amount b { font-size: 18px; color: var(--primary); display: block; }

        .badge {
            font-size: 9px; padding: 3px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase;
        }
        .badge-bank { background: #fdf2f8; color: #9d174d; border: 1px solid #fbcfe8; }

        .del-btn {
            background: #fee2e2;
            color: var(--danger);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 12px;
            font-size: 14px;
            border: 1px solid #fecaca;
            transition: 0.2s;
        }

        .filter-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-section select {
            margin: 0;
            padding: 10px;
            font-size: 14px;
            border-width: 1px;
        }

        .total-box {
            background: #eff6ff;
            border: 2px dashed var(--primary-light);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            margin: 15px 0;
        }
        #sale-total-input {
            background: transparent; border: none; font-size: 32px; font-weight: 900;
            color: var(--primary); text-align: center; padding: 0; margin: 0; width: 100%;
            outline: none;
        }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 3000;
            backdrop-filter: blur(4px);
        }
        .modal-card {
            background: white; padding: 24px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center;
        }

        .hidden { display: none; }
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 80%; }
        .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 12px; text-align: center; font-size: 14px; margin-top: 10px; box-shadow: var(--shadow); }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900; font-size: 20px; letter-spacing: -0.5px;">üìã ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶ñ‡¶æ‡¶§‡¶æ</div>
    <div id="conn-status" class="status-badge">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
</header>

<div id="toast-container"></div>

<div id="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 style="margin: 0;">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</h3>
        <p style="color: var(--text-gray); font-size: 14px;">‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closeModal()" class="btn btn-secondary" style="padding: 12px;">‡¶®‡¶æ</button>
            <button id="confirm-del-btn" class="btn" style="background: var(--danger); color: white; padding: 12px;">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
        </div>
    </div>
</div>

<div class="nav-tabs">
    <div class="nav-tab active" id="tab-btn-sales" onclick="showTab('sales')">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</div>
    <div class="nav-tab" id="tab-btn-history" onclick="showTab('history')">üìä ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ñ‡¶æ‡¶§‡¶æ</div>
</div>

<div class="container">
    <div id="tab-sales" class="tab-content">
        <div class="card">
            <h2>‚ú® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            
            <label>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£</label>
            <select id="sale-item-type" onchange="onTypeChange()">
                <option value="custom">üõçÔ∏è ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option>
                <option value="bkash">üì± ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)</option>
                <option value="nagad">üî∏ ‡¶®‡¶ó‡¶¶ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)</option>
            </select>

            <div id="item-name-box">
                <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="sale-item-name" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ö‡¶æ‡¶≤, ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶æ ‡¶§‡ßá‡¶≤">
            </div>

            <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                    <label id="qty-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                    <input type="number" id="sale-qty" placeholder="‡ß¶" oninput="calculateTotal()">
                </div>
                <div style="flex: 1;">
                    <label id="price-label">‡¶¶‡¶æ‡¶Æ/‡¶∞‡ßá‡¶ü</label>
                    <input type="number" id="sale-price" placeholder="‡ß¶" oninput="calculateTotal()">
                </div>
            </div>

            <label>‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input type="text" id="cust-name" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
            
            <div class="total-box">
                <span id="total-label" style="font-size: 13px; font-weight: 800; color: var(--primary);">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡¶ï‡ßÉ‡¶§ ‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</span>
                <input type="number" id="sale-total-input" value="0.00" step="0.01">
            </div>

            <button onclick="recordTransaction()" class="btn btn-success" style="height: 60px;">
                üíæ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
    </div>

    <div id="tab-history" class="tab-content hidden">
        <div class="card" style="padding: 16px; margin-bottom: 15px;">
            <label style="margin-bottom: 8px; display: block;">üìÖ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ):</label>
            <div class="filter-section">
                <select id="filter-date" onchange="renderHistory()"></select>
                <select id="filter-month" onchange="renderHistory()">
                    <option value="‡ßß">‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø</option>
                    <option value="‡ß®">‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø</option>
                    <option value="‡ß©">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</option>
                    <option value="‡ß™">‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</option>
                    <option value="‡ß´">‡¶Æ‡ßá</option>
                    <option value="‡ß¨">‡¶ú‡ßÅ‡¶®</option>
                    <option value="‡ß≠">‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</option>
                    <option value="‡ßÆ">‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</option>
                    <option value="‡ßØ">‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                    <option value="‡ßß‡ß¶">‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞</option>
                    <option value="‡ßß‡ßß">‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                    <option value="‡ßß‡ß®">‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                </select>
                <select id="filter-year" onchange="renderHistory()"></select>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card bg-sale">
                <div class="summary-title">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</div>
                <div id="stat-total-sale" class="summary-value">‡ß¶ ‡ß≥</div>
            </div>
            <div class="summary-card bg-bank">
                <div class="summary-title">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</div>
                <div id="stat-banking" class="summary-value">‡ß¶.‡ß¶‡ß¶</div>
            </div>
            <div class="summary-card bg-info">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="summary-title">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</span>
                    <b id="stat-count" style="font-size: 20px;">‡ß¶ ‡¶ü‡¶ø</b>
                </div>
            </div>
        </div>

        <div id="history-export-area" class="card" style="padding: 16px;">
            <div style="text-align: center; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                <div id="export-display-date" style="font-weight: 800; color: var(--primary); font-size: 18px;">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡¶æ‡¶≤: --</div>
            </div>
            
            <div id="history-list-items">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</div>
        </div>

        <button onclick="exportHistoryImage()" class="btn btn-secondary">
            üì∏ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
        authDomain: "exchange-project-d4028.firebaseapp.com",
        databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exchange-project-d4028",
        storageBucket: "exchange-project-d4028.firebasestorage.app",
        messagingSenderId: "313976742479",
        appId: "1:313976742479:web:45951b360d875c4768c03a"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'grocery-hisab-final';
    const transPath = `artifacts/${appId}/public/data/transactions`;

    let transactionData = {};
    let deleteTargetKey = null;

    const toBn = (n) => String(n).replace(/\d/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ"[d]);

    function setupFilters() {
        const dSel = document.getElementById('filter-date');
        const ySel = document.getElementById('filter-year');
        const now = new Date();
        
        dSel.innerHTML = '';
        for(let i=1; i<=31; i++) {
            let opt = document.createElement('option');
            opt.value = toBn(i);
            opt.innerText = toBn(i);
            dSel.appendChild(opt);
        }

        ySel.innerHTML = '';
        for(let i=2024; i<=2030; i++) {
            let opt = document.createElement('option');
            opt.value = toBn(i);
            opt.innerText = toBn(i);
            ySel.appendChild(opt);
        }

        const todayStr = now.toLocaleDateString('bn-BD');
        const parts = todayStr.split('/');
        dSel.value = parts[0];
        document.getElementById('filter-month').value = parts[1];
        ySel.value = parts[2];
    }

    setupFilters();

    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerText = msg;
        container.appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }

    firebase.auth().signInAnonymously().then(() => {
        document.getElementById('conn-status').innerText = "‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®";
        document.getElementById('conn-status').style.background = "var(--success)";
        db.ref(transPath).on('value', snap => {
            transactionData = snap.val() || {};
            renderHistory();
        });
    });

    function onTypeChange() {
        const type = document.getElementById('sale-item-type').value;
        const isCustom = type === 'custom';
        document.getElementById('item-name-box').className = isCustom ? '' : 'hidden';
        document.getElementById('qty-label').innerText = isCustom ? "‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" : "‡¶ü‡¶æ‡¶ï‡¶æ (BDT)";
        document.getElementById('price-label').innerText = isCustom ? "‡¶¶‡¶æ‡¶Æ (‡ß≥)" : "‡¶∞‡ßá‡¶ü";
        document.getElementById('total-label').innerText = isCustom ? "‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ (‡ß≥)" : "‡¶Æ‡ßã‡¶ü ‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ (SAR)";
        calculateTotal();
    }

    function calculateTotal() {
        const type = document.getElementById('sale-item-type').value;
        const qty = parseFloat(document.getElementById('sale-qty').value) || 0;
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        let total = (type === 'custom') ? (qty * price) : (price > 0 ? (qty / price).toFixed(2) : 0);
        document.getElementById('sale-total-input').value = total;
    }

    function recordTransaction() {
        const type = document.getElementById('sale-item-type').value;
        const itemName = type === 'custom' ? document.getElementById('sale-item-name').value : (type === 'bkash' ? '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' : '‡¶®‡¶ó‡¶¶ (‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç)');
        const qty = document.getElementById('sale-qty').value;
        const price = document.getElementById('sale-price').value;
        const totalInput = document.getElementById('sale-total-input').value;
        const total = parseFloat(totalInput) || 0;
        const customer = document.getElementById('cust-name').value || "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£";

        if (!itemName || total <= 0) {
            showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®");
            return;
        }

        db.ref(transPath).push({
            itemName, qty, price, total,
            isBanking: type !== 'custom',
            customer,
            date: new Date().toLocaleDateString('bn-BD'),
            timestamp: Date.now()
        }).then(() => {
            showToast("‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚ú®");
            resetForm();
            showTab('history');
        });
    }

    function resetForm() {
        document.getElementById('sale-item-name').value = '';
        document.getElementById('sale-qty').value = '';
        document.getElementById('sale-price').value = '';
        document.getElementById('sale-total-input').value = '0.00';
        document.getElementById('cust-name').value = '';
    }

    function renderHistory() {
        const list = document.getElementById('history-list-items');
        list.innerHTML = '';
        
        const d = document.getElementById('filter-date').value;
        const m = document.getElementById('filter-month').value;
        const y = document.getElementById('filter-year').value;
        const targetDate = `${d}/${m}/${y}`;
        
        document.getElementById('export-display-date').innerText = "‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡¶æ‡¶≤: " + targetDate;

        let totalSale = 0, totalBanking = 0, count = 0;
        const keys = Object.keys(transactionData);
        
        const filteredKeys = keys.filter(key => transactionData[key].date === targetDate);
        const sorted = filteredKeys.sort((a,b) => transactionData[b].timestamp - transactionData[a].timestamp);

        if(sorted.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:gray;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>';
        }

        sorted.forEach(key => {
            const t = transactionData[key];
            count++;
            const isBank = t.isBanking || t.itemName === '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' || t.itemName?.includes('‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç');
            
            if (isBank) totalBanking += parseFloat(t.total);
            else totalSale += parseFloat(t.total);

            const unit = isBank ? '‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤' : '‡ß≥';
            const badge = isBank ? `<span class="badge badge-bank">üè¶ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç</span>` : '';

            list.innerHTML += `
                <div class="list-item">
                    <div class="item-info" style="flex:1;">
                        <b>${t.itemName}</b>
                        <span>üë§ ${t.customer} | ${t.qty} x ${t.price}</span>
                        ${badge}
                    </div>
                    <div class="item-amount">
                        <b>${t.total} ${unit}</b>
                    </div>
                    <div class="del-btn" onclick="askDelete('${key}')">üóëÔ∏è</div>
                </div>`;
        });

        document.getElementById('stat-total-sale').innerText = totalSale.toLocaleString('bn-BD') + " ‡ß≥";
        document.getElementById('stat-banking').innerText = totalBanking.toFixed(2) + " SAR";
        document.getElementById('stat-count').innerText = count.toLocaleString('bn-BD');
    }

    function askDelete(key) {
        deleteTargetKey = key;
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('confirm-del-btn').onclick = function() {
            db.ref(transPath + '/' + deleteTargetKey).remove()
                .then(() => {
                    showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
                    closeModal();
                });
        };
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        deleteTargetKey = null;
    }

    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.getElementById('tab-btn-' + tab).classList.add('active');
        if(tab === 'history') renderHistory();
    }

    function exportHistoryImage() {
        showToast("‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        html2canvas(document.getElementById('history-export-area'), { scale: 3 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `‡¶¶‡ßã‡¶ï‡¶æ‡¶®-‡¶π‡¶ø‡¶∏‡¶æ‡¶¨-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast("‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        });
    }
</script>
</body>
</html>

