<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡ßÅ‡¶¶‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>
    
    <!-- html2canvas for image export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶ø‡¶è‡¶∏‡¶è‡¶∏ */
        :root {
            --fb-blue: #1877F2;
            --fb-bg: #F0F2F5;
            --fb-white: #FFFFFF;
            --fb-gray: #65676B;
            --fb-border: #CED0D4;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--fb-bg);
            color: #1c1e21;
        }

        header {
            background-color: var(--fb-blue);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            background: var(--fb-white);
            border-bottom: 1px solid var(--fb-border);
            position: sticky;
            top: 48px;
            z-index: 999;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            cursor: pointer;
            color: var(--fb-gray);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
        }

        .nav-tab.active {
            color: var(--fb-blue);
            border-bottom-color: var(--fb-blue);
        }

        .container {
            padding: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            background: var(--fb-white);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        h2 { font-size: 1.1rem; margin: 0 0 12px 0; color: #1c1e21; }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--fb-border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            outline: none;
        }

        button {
            background-color: var(--fb-blue);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        button:active { opacity: 0.8; transform: scale(0.98); }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .list-item:last-child { border-bottom: none; }

        .price-tag { color: #42b72a; font-weight: bold; }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-cash { background: #e7f3ff; color: #1877f2; }
        .badge-credit { background: #ffebe9; color: #f02849; }

        .status-bar {
            text-align: center;
            font-size: 12px;
            color: #42b72a;
            padding: 5px;
            display: none;
        }

        .hidden { display: none; }

        /* Style for Export Button */
        .btn-export {
            background-color: #f0f2f5;
            color: #1c1e21;
            border: 1px solid var(--fb-border);
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.2rem;">üõí ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶ñ‡¶æ‡¶§‡¶æ</div>
    <div id="conn-status" style="font-size: 10px; background: #42b72a; padding: 2px 6px; border-radius: 10px;">‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§</div>
</header>

<div class="nav-tabs">
    <div class="nav-tab active" id="tab-btn-stock" onclick="showTab('stock')">‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï</div>
    <div class="nav-tab" id="tab-btn-sales" onclick="showTab('sales')">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</div>
    <div class="nav-tab" id="tab-btn-history" onclick="showTab('history')">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ñ‡¶æ‡¶§‡¶æ</div>
</div>

<div class="container">
    <div id="status-msg" class="status-bar">‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!</div>

    <!-- Stock Management -->
    <div id="tab-stock" class="tab-content">
        <div class="card">
            <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <input type="text" id="p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ö‡¶ø‡¶®‡¶ø)">
            <input type="number" id="p-price" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)">
            <button onclick="saveProduct()">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        <div class="card">
            <h2>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶£‡ßç‡¶Ø‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div id="inventory-list">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        </div>
    </div>

    <!-- Sales Management -->
    <div id="tab-sales" class="tab-content hidden">
        <div class="card">
            <h2>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
            <select id="sale-prod-select">
                <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
            </select>
            <input type="number" id="sale-qty" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ï‡ßá‡¶ú‡¶ø/‡¶™‡¶ø‡¶∏)">
            <input type="text" id="cust-name" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
            
            <div style="display: flex; gap: 8px;">
                <button onclick="recordTransaction('cash')" style="background-color: #42b72a; flex: 1;">‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</button>
                <button onclick="recordTransaction('credit')" style="background-color: #f02849; flex: 1;">(‡¶¨‡¶æ‡¶ï‡¶ø)</button>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div id="tab-history" class="tab-content hidden">
        <div class="card" id="export-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                <h2 style="margin:0;">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h2>
                <span id="total-cash-today" style="font-size: 12px; font-weight: bold; color: #1877f2;"></span>
            </div>
            <div id="history-list">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á</div>
        </div>
        <button class="btn-export" onclick="exportAsImage()">
            üì∑ ‡¶õ‡¶¨‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>
</div>

<script>
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    const firebaseConfig = {
        apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
        authDomain: "exchange-project-d4028.firebaseapp.com",
        databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exchange-project-d4028",
        storageBucket: "exchange-project-d4028.firebasestorage.app",
        messagingSenderId: "313976742479",
        appId: "1:313976742479:web:45951b360d875c4768c03a",
        measurementId: "G-PQMFYZS958"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'grocery-shop-01';

    let inventoryData = {};

    auth.signInAnonymously().catch(err => console.error("Auth Error", err));

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('conn-status').innerText = "‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®";
            setupListeners();
        } else {
            document.getElementById('conn-status').innerText = "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®";
            document.getElementById('conn-status').style.background = "#65676B";
        }
    });

    const invPath = `artifacts/${appId}/public/data/inventory`;
    const transPath = `artifacts/${appId}/public/data/transactions`;

    function setupListeners() {
        db.ref(invPath).on('value', snapshot => {
            inventoryData = snapshot.val() || {};
            renderInventory();
            updateDropdown();
        });

        db.ref(transPath).limitToLast(50).on('value', snapshot => {
            renderHistory(snapshot.val() || {});
        });
    }

    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.getElementById('tab-btn-' + tab).classList.add('active');
    }

    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        if (!name || !price) return alert("‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ò‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®");

        db.ref(invPath).push({
            name: name,
            price: parseFloat(price),
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            showMessage();
        });
    }

    function recordTransaction(type) {
        const prodId = document.getElementById('sale-prod-select').value;
        const qty = document.getElementById('sale-qty').value;
        const customer = document.getElementById('cust-name').value;

        if (!prodId || !qty) return alert("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®");
        if (type === 'credit' && !customer) return alert(" ‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");

        const product = inventoryData[prodId];
        const total = product.price * parseFloat(qty);

        db.ref(transPath).push({
            itemName: product.name,
            qty: qty,
            price: product.price,
            total: total,
            type: type,
            buyer: customer || "‡¶®‡¶ó‡¶¶ ‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ",
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('sale-qty').value = '';
            document.getElementById('cust-name').value = '';
            showMessage();
            showTab('history');
        });
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        const keys = Object.keys(inventoryData).reverse();
        if (keys.length === 0) list.innerHTML = "‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§";

        keys.forEach(key => {
            const item = inventoryData[key];
            list.innerHTML += `
                <div class="list-item">
                    <span>${item.name}</span>
                    <span class="price-tag">${item.price} ‡ß≥</span>
                </div>
            `;
        });
    }

    function updateDropdown() {
        const select = document.getElementById('sale-prod-select');
        select.innerHTML = '<option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
        Object.keys(inventoryData).forEach(key => {
            select.innerHTML += `<option value="${key}">${inventoryData[key].name} (${inventoryData[key].price} ‡ß≥)</option>`;
        });
    }

    function renderHistory(data) {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const keys = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);
        
        let todayCash = 0;
        keys.forEach(key => {
            const t = data[key];
            if (t.type === 'cash') todayCash += t.total;
            const badge = t.type === 'cash' ? 
                '<span class="badge badge-cash">‡¶®‡¶ó‡¶¶</span>' : 
                '<span class="badge badge-credit">‡¶¨‡¶æ‡¶ï‡¶ø</span>';
            
            list.innerHTML += `
                <div class="list-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <strong>${t.itemName} (${t.qty})</strong>
                        ${badge}
                    </div>
                    <div style="display: flex; justify-content: space-between; width: 100%; font-size: 13px; color: var(--fb-gray);">
                        <span>‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ: ${t.buyer}</span>
                        <span class="price-tag">${t.total} ‡ß≥</span>
                    </div>
                </div>
            `;
        });
        document.getElementById('total-cash-today').innerText = "‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø: " + todayCash + " ‡ß≥";
    }

    function showMessage() {
        const msg = document.getElementById('status-msg');
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 2000);
    }

    // New Function: Export History as Image
    function exportAsImage() {
        const element = document.getElementById('export-area');
        const btn = document.querySelector('.btn-export');
        
        // ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá
        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ö‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡¶ø
        
        html2canvas(element, {
            backgroundColor: "#FFFFFF",
            scale: 2 // ‡¶≠‡¶æ‡¶≤‡ßã ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = '‡¶¶‡ßã‡¶ï‡¶æ‡¶®-‡¶ñ‡¶æ‡¶§‡¶æ-' + new Date().toLocaleDateString() + '.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        }).catch(err => {
            console.error("Export Error:", err);
            alert("‡¶õ‡¶¨‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá!");
        });
    }
</script>

</body>
</html>

