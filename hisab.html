<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ - ‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --bg-light: #f3f4f6;
            --card-light: #ffffff;
            --text-light: #1f2937;
        }

        .dark-theme {
            --bg-light: #0b0f1a;
            --card-light: #161b2c;
            --text-light: #f3f4f6;
        }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-theme .glass {
            background: rgba(22, 27, 44, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .summary-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }

        .active-scale:active {
            transform: scale(0.96);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-modal {
            animation: modalSlideUp 0.3s ease-out forwards;
        }

        /* Export Fix: ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶™‡¶ú‡¶ø‡¶∂‡¶® ‡¶†‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá */
        .capturing {
            width: 380px !important;
            margin: 0 !important;
            padding: 20px !important;
            position: absolute;
            left: -9999px;
            top: 0;
            background-color: var(--bg-light);
        }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Top Floating Header -->
    <nav class="sticky top-0 z-40 px-4 py-3 glass mb-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-300 dark:shadow-none">‡¶¶</div>
                <div>
                    <h1 class="font-bold text-lg leading-none">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h1>
                    <span class="text-[10px] opacity-60 font-semibold uppercase tracking-wider">Premium Dashboard</span>
                </div>
            </div>
            <button id="btnTheme" class="w-10 h-10 rounded-xl flex items-center justify-center bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-sm transition-all active-scale">
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l.707-.707M6.343 6.343l.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" /></svg>
            </button>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-4">
        
        <!-- Date Filters (Modern Pills) -->
        <div class="flex items-center gap-2 mb-6 overflow-x-auto no-scrollbar py-1" data-html2canvas-ignore="true">
            <div id="boxDay" class="flex-shrink-0 px-4 py-2 bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 flex flex-col items-center cursor-pointer active-scale shadow-sm">
                <span class="text-[9px] opacity-50 font-bold">‡¶¶‡¶ø‡¶®</span>
                <span id="valDay" class="font-bold text-indigo-600">--</span>
            </div>
            <div id="boxMonth" class="flex-shrink-0 px-4 py-2 bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 flex flex-col items-center cursor-pointer active-scale shadow-sm">
                <span class="text-[9px] opacity-50 font-bold">‡¶Æ‡¶æ‡¶∏</span>
                <span id="valMonth" class="font-bold text-indigo-600">--</span>
            </div>
            <div id="boxYear" class="flex-shrink-0 px-4 py-2 bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 flex flex-col items-center cursor-pointer active-scale shadow-sm">
                <span class="text-[9px] opacity-50 font-bold">‡¶¨‡¶õ‡¶∞</span>
                <span id="valYear" class="font-bold text-indigo-600">----</span>
            </div>
            <div class="h-10 w-[1px] bg-slate-200 dark:bg-slate-700 mx-1"></div>
            <button id="boxToday" class="flex-shrink-0 px-5 py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 font-bold rounded-2xl border border-indigo-100 dark:border-indigo-800 active-scale">‡¶Ü‡¶ú</button>
            <button id="boxReport" class="flex-shrink-0 px-5 py-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 font-bold rounded-2xl border border-emerald-100 dark:border-emerald-800 active-scale">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
        </div>

        <!-- Capture Area Wrapper -->
        <div id="captureArea" class="space-y-4">
            <!-- Balance Card -->
            <div class="summary-gradient rounded-[32px] p-8 text-white shadow-xl relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
                <div class="relative z-10">
                    <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest opacity-80 mb-1" id="currentDateDisp">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                    <h2 class="text-4xl font-black mb-1" id="totalBalance">‡ß≥ ‡ß¶</h2>
                    <p class="text-[10px] text-white/60 font-medium uppercase tracking-tighter">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç)</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-8 relative z-10">
                    <div class="bg-white/10 backdrop-blur-md p-3 rounded-2xl">
                        <span class="text-[10px] text-white/50 block font-bold uppercase">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        <strong class="text-xl" id="topNetProfit">‡ß≥ ‡ß¶</strong>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md p-3 rounded-2xl">
                        <span class="text-[10px] text-white/50 block font-bold uppercase">‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span>
                        <strong class="text-xl" id="productSaleOnly">‡ß≥ ‡ß¶</strong>
                    </div>
                </div>
            </div>

            <!-- List of Action Items -->
            <div class="grid grid-cols-1 gap-3">
                <!-- Opening -->
                <div id="cardOpening" class="bg-white dark:bg-slate-800 p-4 rounded-3xl flex justify-between items-center cursor-pointer border dark:border-slate-700 active-scale card-shadow">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/40 rounded-2xl flex items-center justify-center text-blue-600 text-xl">üí∏</div>
                        <div>
                            <h4 class="font-bold text-base leading-none mb-1">‡¶ì‡¶™‡ßá‡¶®‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂</h4>
                            <p class="text-[10px] opacity-40 font-medium uppercase">‡¶∏‡¶ï‡¶æ‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                        </div>
                    </div>
                    <span id="dispOpening" class="font-bold text-lg text-blue-600">‡ß≥ ‡ß¶</span>
                </div>

                <!-- Expense -->
                <div id="cardExpense" class="bg-white dark:bg-slate-800 p-4 rounded-3xl flex justify-between items-center cursor-pointer border-l-4 border-l-orange-500 active-scale card-shadow">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/40 rounded-2xl flex items-center justify-center text-orange-600 text-xl">üç±</div>
                        <div>
                            <h4 class="font-bold text-base leading-none mb-1">‡¶Æ‡¶®‡¶¶‡ßÅ‡¶≠ ‡¶ñ‡¶∞‡¶ö</h4>
                            <p class="text-[10px] opacity-40 font-medium uppercase">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡ßü</p>
                        </div>
                    </div>
                    <span id="dispMandub" class="font-bold text-lg text-orange-600">‡ß≥ ‡ß¶</span>
                </div>

                <!-- Due -->
                <div id="cardDue" class="bg-white dark:bg-slate-800 p-4 rounded-3xl flex justify-between items-center cursor-pointer border-l-4 border-l-rose-500 active-scale card-shadow">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/40 rounded-2xl flex items-center justify-center text-rose-600 text-xl">üìù</div>
                        <div>
                            <h4 class="font-bold text-base leading-none mb-1">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</h4>
                            <p class="text-[10px] opacity-40 font-medium uppercase">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                        </div>
                    </div>
                    <span id="dispDue" class="font-bold text-lg text-rose-600">‡ß≥ ‡ß¶</span>
                </div>

                <!-- Bkash -->
                <div id="cardBkash" class="bg-white dark:bg-slate-800 p-4 rounded-3xl flex justify-between items-center cursor-pointer border-l-4 border-l-purple-500 active-scale card-shadow">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/40 rounded-2xl flex items-center justify-center text-purple-600 text-xl">üì±</div>
                        <div>
                            <h4 class="font-bold text-base leading-none mb-1">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂-‡¶®‡¶ó‡¶¶</h4>
                            <p id="bkashDetail" class="text-[10px] opacity-40 font-medium uppercase italic leading-tight">‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã: ‡ß¶ | ‡¶Ü‡¶®‡¶æ: ‡ß¶</p>
                        </div>
                    </div>
                    <span id="dispBkash" class="font-bold text-lg text-purple-600">‡ß≥ ‡ß¶</span>
                </div>

                <!-- Closing -->
                <div id="cardClosing" class="bg-white dark:bg-slate-800 p-4 rounded-3xl flex justify-between items-center cursor-pointer border-l-4 border-l-emerald-500 active-scale card-shadow">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/40 rounded-2xl flex items-center justify-center text-emerald-600 text-xl">üè¶</div>
                        <div>
                            <h4 class="font-bold text-base leading-none mb-1">‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂</h4>
                            <p class="text-[10px] opacity-40 font-medium uppercase">‡¶¶‡¶ø‡¶® ‡¶∂‡ßá‡¶∑‡ßá ‡¶ó‡¶æ‡¶≤‡ßç‡¶≤‡¶æ</p>
                        </div>
                    </div>
                    <span id="dispClosing" class="font-bold text-lg text-emerald-600">‡ß≥ ‡ß¶</span>
                </div>
            </div>
        </div>

        <button id="btnExport" class="w-full mt-6 py-5 bg-slate-900 dark:bg-indigo-600 text-white font-bold rounded-3xl shadow-xl flex items-center justify-center gap-2 active-scale transition-all" data-html2canvas-ignore="true">
            üì∏ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </main>

    <!-- Entry Modal -->
    <div id="entryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-t-[40px] p-6 shadow-2xl animate-modal max-h-[90vh] flex flex-col">
            <div class="w-12 h-1 bg-slate-300 dark:bg-slate-700 rounded-full mx-auto mb-6"></div>
            <div class="flex justify-between items-center mb-6 px-2">
                <h3 class="text-xl font-bold" id="modalTitle">‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤</h3>
                <button id="closeEntryModal" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full">‚úï</button>
            </div>
            <div id="modalInputs" class="mb-4"></div>
            <div id="modalList" class="flex-1 overflow-y-auto custom-scroll space-y-2 mb-4 px-1"></div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-3xl flex justify-between items-center border dark:border-slate-800">
                <span class="text-xs font-bold opacity-50 uppercase tracking-widest">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</span>
                <strong id="modalTotalDisp" class="text-2xl font-black text-indigo-600">‡ß≥ ‡ß¶</strong>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="pickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[32px] p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 px-2" id="pickerTitle">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <div class="grid grid-cols-4 gap-2 max-h-[300px] overflow-y-auto custom-scroll pr-2" id="pickerGrid"></div>
            <button id="closePicker" class="w-full mt-6 py-4 bg-slate-100 dark:bg-slate-800 font-bold rounded-2xl active-scale">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[32px] p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø</h3>
                <button id="closeReport" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full">‚úï</button>
            </div>
            <div class="flex gap-2 mb-6">
                <button id="btnWeekly" class="flex-1 py-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 font-bold rounded-2xl active-scale border border-indigo-100 dark:border-indigo-800">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï</button>
                <button id="btnMonthly" class="flex-1 py-4 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 font-bold rounded-2xl active-scale border border-emerald-100 dark:border-emerald-800">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</button>
            </div>
            <div id="reportCaptureArea" class="bg-slate-50 dark:bg-slate-950 p-6 rounded-[24px] border border-slate-200 dark:border-slate-800">
                <div class="text-center mb-4">
                    <h4 class="text-lg font-bold" id="reportTitle">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h4>
                    <p class="text-[10px] opacity-40 font-bold tracking-widest uppercase" id="reportRange">...</p>
                </div>
                <div id="reportContent" class="space-y-3"></div>
            </div>
            <button id="btnDownloadReport" class="w-full mt-6 py-5 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg active-scale">‡¶´‡¶ü‡ßã ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, remove, off, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
            databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "exchange-project-d4028",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const banglaMonths = ["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
        const banglaDigits = {'0':'‡ß¶','1':'‡ßß','2':'‡ß®','3':'‡ß©','4':'‡ß™','5':'‡ß´','6':'‡ß¨','7':'‡ß≠','8':'‡ßÆ','9':'‡ßØ'};
        const toBangla = (num) => num.toString().split('').map(d => banglaDigits[d] || d).join('');

        let now = new Date();
        let currentS = { d: now.getDate(), m: now.getMonth(), y: now.getFullYear() };
        let activeListeners = [];

        const toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                el.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        };

        const getDateKey = (date) => {
            const d = date || new Date(currentS.y, currentS.m, currentS.d);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const refreshData = () => {
            activeListeners.forEach(l => off(l.ref)); 
            activeListeners = [];
            const dateKey = getDateKey();
            const cashRef = ref(db, `daily_records/${dateKey}/cash`);

            onValue(cashRef, (snap) => {
                const data = snap.val() || {};
                const op = data.opening || 0;
                const cl = data.closing || 0;
                const ex = data.expense_total || 0;
                const du = data.due_total || 0;
                const bin = data.bk_in || 0;
                const bout = data.bk_out || 0;

                document.getElementById('dispOpening').innerText = `‡ß≥ ${op}`;
                document.getElementById('dispClosing').innerText = `‡ß≥ ${cl}`;
                document.getElementById('dispMandub').innerText = `‡ß≥ ${ex}`;
                document.getElementById('dispDue').innerText = `‡ß≥ ${du}`;
                document.getElementById('dispBkash').innerText = `‡ß≥ ${bin - bout}`;
                document.getElementById('bkashDetail').innerText = `‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã: ${bin} | ‡¶Ü‡¶®‡¶æ: ${bout}`;
                
                const cashSale = (cl + ex + bout) - (op + bin);
                const totalSale = cashSale + du;

                document.getElementById('topNetProfit').innerText = `‡ß≥ ${totalSale}`;
                document.getElementById('productSaleOnly').innerText = `‡ß≥ ${cashSale}`;
                document.getElementById('totalBalance').innerText = `‡ß≥ ${cl}`;
            });
            activeListeners.push({ ref: cashRef });
        };

        const openDetailModal = (type) => {
            const dateKey = getDateKey();
            const modalTitle = document.getElementById('modalTitle');
            const inputs = document.getElementById('modalInputs');
            const totalDisp = document.getElementById('modalTotalDisp');
            let path = "";

            if(type === 'bkash') {
                modalTitle.innerText = "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂-‡¶®‡¶ó‡¶¶ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨";
                inputs.innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="mSub1" class="p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none font-bold"><option value="bKash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option><option value="Nagad">‡¶®‡¶ó‡¶¶</option></select>
                        <select id="mSub2" class="p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none font-bold"><option value="‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã (+)</option><option value="‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ü‡¶®‡¶æ">‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ü‡¶®‡¶æ (-)</option></select>
                    </div>
                    <input type="number" id="mAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none font-bold text-lg mb-2">
                    <button id="mAdd" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 dark:shadow-none active-scale">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                path = `daily_records/${dateKey}/bkash_transactions`;
            } else if(type === 'due') {
                modalTitle.innerText = "‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£";
                inputs.innerHTML = `
                    <input type="text" id="mSub1" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none mb-2">
                    <input type="number" id="mAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none font-bold text-lg mb-2">
                    <button id="mAdd" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-bold active-scale">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                path = `daily_records/${dateKey}/due_transactions`;
            } else if(type === 'expense') {
                modalTitle.innerText = "‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶Æ‡¶®‡¶¶‡ßÅ‡¶≠)";
                inputs.innerHTML = `
                    <input type="text" id="mSub1" placeholder="‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶®‡¶æ‡¶∏‡ßç‡¶§‡¶æ)" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none mb-2">
                    <input type="number" id="mAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none font-bold text-lg mb-2">
                    <button id="mAdd" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-bold active-scale">‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                path = `daily_records/${dateKey}/expense_transactions`;
            }

            document.getElementById('mAdd').onclick = async () => {
                const s1 = document.getElementById('mSub1').value;
                const amt = parseFloat(document.getElementById('mAmount').value);
                if(!amt) return;
                const data = type === 'bkash' ? { method: s1, type: document.getElementById('mSub2').value, amount: amt } : { name: s1, amount: amt };
                await push(ref(db, path), data);
                document.getElementById('mAmount').value = "";
            };

            onValue(ref(db, path), (snap) => {
                const list = document.getElementById('modalList');
                list.innerHTML = "";
                let total = 0, bin = 0, bout = 0;
                if(snap.exists()) {
                    Object.entries(snap.val()).reverse().forEach(([k, v]) => {
                        const isBkash = type === 'bkash';
                        if(isBkash) { if(v.type === "‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã") bin += v.amount; else bout += v.amount; } else total += v.amount;
                        list.innerHTML += `<div class="flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border dark:border-slate-700">
                                <div class="flex flex-col"><span class="font-bold text-sm">${isBkash ? v.method : v.name}</span><span class="text-[9px] font-bold uppercase ${v.type==='‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã' ? 'text-indigo-500' : (v.type ? 'text-rose-500' : 'text-slate-400')}">${v.type || '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø'}</span></div>
                                <div class="flex items-center gap-3"><strong class="text-indigo-600 dark:text-indigo-400">‡ß≥ ${v.amount}</strong><button onclick="delEntry('${path}/${k}')" class="w-8 h-8 flex items-center justify-center bg-rose-50 dark:bg-rose-900/30 text-rose-500 rounded-xl">‚úï</button></div></div>`;
                    });
                }
                if(type === 'bkash') { 
                    totalDisp.innerText = `‡ß≥ ${bin - bout}`;
                    set(ref(db, `daily_records/${dateKey}/cash/bk_in`), bin); 
                    set(ref(db, `daily_records/${dateKey}/cash/bk_out`), bout);
                } else {
                    totalDisp.innerText = `‡ß≥ ${total}`;
                    set(ref(db, `daily_records/${dateKey}/cash/${type === 'due' ? 'due_total' : 'expense_total'}`), total);
                }
            });
            toggleModal('entryModal', true);
        };

        window.delEntry = (p) => confirm('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?') ? remove(ref(db, p)) : null;

        const updateUI = () => {
            document.getElementById('valDay').innerText = toBangla(currentS.d);
            document.getElementById('valMonth').innerText = banglaMonths[currentS.m];
            document.getElementById('valYear').innerText = toBangla(currentS.y);
            document.getElementById('currentDateDisp').innerText = `${toBangla(currentS.d)} ${banglaMonths[currentS.m]} ${toBangla(currentS.y)}`;
            refreshData();
        };

        document.getElementById('boxDay').onclick = () => showPicker('day');
        document.getElementById('boxMonth').onclick = () => showPicker('month');
        document.getElementById('boxYear').onclick = () => showPicker('year');
        document.getElementById('boxToday').onclick = () => { currentS = { d: now.getDate(), m: now.getMonth(), y: now.getFullYear() }; updateUI(); };
        document.getElementById('closePicker').onclick = () => toggleModal('pickerModal', false);

        document.getElementById('cardBkash').onclick = () => openDetailModal('bkash');
        document.getElementById('cardDue').onclick = () => openDetailModal('due');
        document.getElementById('cardExpense').onclick = () => openDetailModal('expense');
        document.getElementById('closeEntryModal').onclick = () => toggleModal('entryModal', false);
        document.getElementById('cardOpening').onclick = () => { const v = prompt('‡¶ì‡¶™‡ßá‡¶®‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂:'); if(v) set(ref(db, `daily_records/${getDateKey()}/cash/opening`), parseFloat(v)); };
        document.getElementById('cardClosing').onclick = () => { const v = prompt('‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂:'); if(v) set(ref(db, `daily_records/${getDateKey()}/cash/closing`), parseFloat(v)); };

        // Optimized Capture Function
        async function captureAndSave(elementId, fileName) {
            const el = document.getElementById(elementId);
            const originalStyles = el.getAttribute('style') || "";
            
            // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ö‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï ‡¶â‡¶á‡¶°‡¶• ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶∞‡ßá ‡¶®‡¶æ ‡¶Ø‡¶æ‡ßü
            el.classList.add('capturing');
            
            try {
                // ‡¶´‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø
                await document.fonts.ready;
                
                const canvas = await html2canvas(el, {
                    backgroundColor: document.body.classList.contains('dark-theme') ? '#0b0f1a' : '#f3f4f6',
                    scale: 3, 
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 400, // ‡¶≠‡¶æ‡¶∞‡ßç‡¶ö‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶â‡¶á‡¶°‡¶• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                    onclone: (clonedDoc) => {
                        const clonedEl = clonedDoc.getElementById(elementId);
                        clonedEl.style.position = "static";
                        clonedEl.style.left = "0";
                        clonedEl.style.width = "380px";
                        clonedEl.style.margin = "0";
                        clonedEl.style.padding = "20px";
                        clonedEl.classList.remove('capturing');
                    }
                });

                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL("image/png", 1.0);
                link.click();
            } catch (err) {
                console.error("Capture failed:", err);
            } finally {
                // ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                el.classList.remove('capturing');
                el.setAttribute('style', originalStyles);
            }
        }

        document.getElementById('btnExport').onclick = () => captureAndSave('captureArea', `Daily_Report_${getDateKey()}.png`);
        document.getElementById('btnDownloadReport').onclick = () => captureAndSave('reportCaptureArea', `Summary_Report.png`);

        // Report & Picker logic
        const showPicker = (t) => {
            const grid = document.getElementById('pickerGrid'); grid.innerHTML = "";
            if(t==='day') for(let i=1;i<=31;i++) { const b=document.createElement('div'); b.className="p-3 text-center rounded-xl bg-slate-50 dark:bg-slate-800 font-bold cursor-pointer"; b.innerText=toBangla(i); b.onclick=()=>{currentS.d=i;updateUI();toggleModal('pickerModal',false)}; grid.appendChild(b); }
            else if(t==='month') banglaMonths.forEach((m,i)=>{ const b=document.createElement('div'); b.className="col-span-2 p-3 text-center rounded-xl bg-slate-50 dark:bg-slate-800 font-bold cursor-pointer"; b.innerText=m; b.onclick=()=>{currentS.m=i;updateUI();toggleModal('pickerModal',false)}; grid.appendChild(b); });
            else for(let i=2025;i<=2030;i++) { const b=document.createElement('div'); b.className="col-span-2 p-3 text-center rounded-xl bg-slate-50 dark:bg-slate-800 font-bold cursor-pointer"; b.innerText=toBangla(i); b.onclick=()=>{currentS.y=i;updateUI();toggleModal('pickerModal',false)}; grid.appendChild(b); }
            toggleModal('pickerModal', true);
        };

        const generateReport = async (type) => {
            const content = document.getElementById('reportContent');
            content.innerHTML = `<div class="p-8 text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>`;
            let dates = [];
            if(type === 'weekly') { for(let i=0; i<7; i++) { let d = new Date(currentS.y, currentS.m, currentS.d); d.setDate(d.getDate() - i); dates.push(getDateKey(d)); } document.getElementById('reportTitle').innerText = "‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü"; }
            else { const last = new Date(currentS.y, currentS.m + 1, 0).getDate(); for(let i=1; i<=last; i++) dates.push(`${currentS.y}-${String(currentS.m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`); document.getElementById('reportTitle').innerText = banglaMonths[currentS.m] + " ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü"; }
            const snapshot = await get(ref(db, `daily_records`));
            const all = snapshot.val() || {};
            let t = { net: 0, cash: 0, exp: 0, due: 0 };
            dates.forEach(d => { if(all[d]) { const day = all[d].cash || {}; const cs = ((day.closing||0)+(day.expense_total||0)+(day.bk_out||0)) - ((day.opening||0)+(day.bk_in||0)); t.cash += cs; t.due += (day.due_total||0); t.exp += (day.expense_total||0); t.net += (cs + (day.due_total||0)); } });
            content.innerHTML = `<div class="grid grid-cols-2 gap-3 text-sm"><div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-2xl border border-emerald-100 dark:border-emerald-800"><span class="opacity-60 text-[10px] font-bold block mb-1">‡¶®‡¶ø‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span><div class="text-xl font-black text-emerald-600 dark:text-emerald-400">‡ß≥ ${t.net}</div></div><div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border border-indigo-100 dark:border-indigo-800"><span class="opacity-60 text-[10px] font-bold block mb-1">‡¶®‡¶ó‡¶¶ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span><div class="text-xl font-black text-indigo-600 dark:text-indigo-400">‡ß≥ ${t.cash}</div></div><div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-2xl border border-orange-100 dark:border-orange-800"><span class="opacity-60 text-[10px] font-bold block mb-1">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</span><div class="text-xl font-black text-orange-600 dark:text-orange-400">‡ß≥ ${t.exp}</div></div><div class="p-4 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-800"><span class="opacity-60 text-[10px] font-bold block mb-1">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø</span><div class="text-xl font-black text-rose-600 dark:text-rose-400">‡ß≥ ${t.due}</div></div></div>`;
            document.getElementById('reportRange').innerText = `${toBangla(dates[dates.length-1])} ‡¶•‡ßá‡¶ï‡ßá ${toBangla(dates[0])}`;
        };

        document.getElementById('boxReport').onclick = () => { toggleModal('reportModal', true); generateReport('weekly'); };
        document.getElementById('btnWeekly').onclick = () => generateReport('weekly');
        document.getElementById('btnMonthly').onclick = () => generateReport('monthly');
        document.getElementById('closeReport').onclick = () => toggleModal('reportModal', false);
        document.getElementById('btnTheme').onclick = () => { document.body.classList.toggle('dark-theme'); document.getElementById('sunIcon').classList.toggle('hidden'); document.getElementById('moonIcon').classList.toggle('hidden'); };

        updateUI();
    </script>
</body>
</html>

