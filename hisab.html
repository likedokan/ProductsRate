<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>দোকানের হিসাব - প্রো</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-color: #f8fafc; --card-bg: #ffffff; --text-main: #1e293b; --border-color: #f1f5f9; }
        .dark-theme { --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --border-color: #334155; }
        body { font-family: 'Hind Siliguri', sans-serif; background-color: var(--bg-color); color: var(--text-main); padding: 16px; transition: all 0.3s ease; }
        .main-container { margin-bottom: 120px; padding: 10px; border-radius: 20px; }
        .summary-card { background-color: var(--card-bg); padding: 14px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.02); margin-bottom: 8px; cursor: pointer; }
        .filter-box { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; flex: 1; }
        .filter-box:active { transform: scale(0.95); background: #f1f5f9; }
        /* "আজ" বক্সের জন্য একটু আলাদা স্টাইল */
        #boxToday { border-color: #3b82f6; color: #3b82f6; }
        .transaction-list::-webkit-scrollbar { width: 4px; }
        .transaction-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .picker-item { padding: 10px; text-align: center; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; font-size: 14px; }
        .picker-item:hover { background: #3b82f6; color: white; }
    </style>
</head>
<body>

    <div id="captureArea" class="max-w-md mx-auto main-container">
        <!-- তারিখ ফিল্টার সেকশন -->
        <div class="flex gap-2 mb-6" data-html2canvas-ignore="true">
            <div class="filter-box" id="boxDay">
                <span class="text-[10px] opacity-50 block uppercase font-bold">দিন</span>
                <span class="text-lg font-bold" id="valDay">--</span>
            </div>
            <div class="filter-box" id="boxMonth">
                <span class="text-[10px] opacity-50 block uppercase font-bold">মাস</span>
                <span class="text-sm font-bold" id="valMonth">--</span>
            </div>
            <div class="filter-box" id="boxYear">
                <span class="text-[10px] opacity-50 block uppercase font-bold">বছর</span>
                <span class="text-lg font-bold" id="valYear">----</span>
            </div>
            <!-- নতুন "আজ" বক্স -->
            <div class="filter-box flex items-center justify-center" id="boxToday">
                <span class="text-sm font-bold uppercase">আজ</span>
            </div>
        </div>

        <header class="flex justify-between items-center mb-6">
            <div class="text-left">
                <h1 class="text-2xl font-bold">আয়-ব্যয় ট্র্যাকার</h1>
                <p class="text-sm opacity-70" id="currentDateDisp"></p>
            </div>
            <div class="flex gap-2" data-html2canvas-ignore="true">
                <button id="btnExport" class="p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812-1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button id="btnTheme" class="p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700">
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l.707-.707M6.343 6.343l.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" /></svg>
                    <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <div class="space-y-4 mb-6">
            <div class="bg-slate-900 p-6 rounded-3xl shadow-lg text-white text-center">
                <span class="text-slate-400 text-sm block mb-1">মোট ক্যাশ ইন হ্যান্ড (গাল্লা)</span>
                <h2 class="text-4xl font-bold" id="totalBalance">৳ ০.০০</h2>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                    <span class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase block mb-1">আজকের নিট বিক্রি</span>
                    <strong class="text-lg text-emerald-500" id="topNetProfit">৳ ০</strong>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                    <span class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase block mb-1">শুধুমাত্র পণ্য বিক্রি</span>
                    <strong class="text-lg text-blue-500" id="productSaleOnly">৳ ০</strong>
                </div>
            </div>

            <div class="space-y-2 mt-6">
                <div class="summary-card">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-500/10 rounded-lg text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </div>
                        <span class="font-semibold">ওপেনিং ক্যাশ</span>
                    </div>
                    <strong id="dispOpening">৳ ০</strong>
                </div>

                <div class="summary-card">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        </div>
                        <span class="font-semibold">মনদুভ বিল (খরচ)</span>
                    </div>
                    <strong class="text-orange-500" id="dispMandub">৳ ০</strong>
                </div>

                <div class="summary-card" id="bkashCard">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-purple-500/10 rounded-lg text-purple-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        </div>
                        <div>
                            <span class="font-semibold block">বিকাশ-নগদ নিট</span>
                            <span class="text-[9px] opacity-50" id="bkashDetail">পাঠানো: ০ | রিয়াল আনা: ০</span>
                        </div>
                    </div>
                    <strong class="text-purple-600" id="dispBkash">৳ ০</strong>
                </div>

                <div class="summary-card">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <span class="font-semibold">ক্লোজিং ক্যাশ</span>
                    </div>
                    <strong id="dispClosing">৳ ০</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- ক্যাশ আপডেট বাটন -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 px-4 py-3 flex justify-around items-center z-40 max-w-md mx-auto rounded-t-2xl">
        <button id="btnCashCalc" class="flex flex-col items-center gap-1 opacity-60 p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <span class="text-[10px] font-bold uppercase">ক্যাশ আপডেট</span>
        </button>
    </div>

    <!-- তারিখ পিকার মডাল -->
    <div id="pickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[60] p-6">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-hidden">
            <h3 class="text-xl font-bold mb-4" id="pickerTitle">সিলেক্ট করুন</h3>
            <div class="picker-grid max-h-[300px] overflow-y-auto pr-2" id="pickerGrid"></div>
            <button id="closePicker" class="w-full mt-4 py-3 bg-slate-100 dark:bg-slate-700 font-bold rounded-xl">বন্ধ করুন</button>
        </div>
    </div>

    <!-- বিকাশ-নগদ মডাল -->
    <div id="bkashModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-end justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-t-[32px] p-6 shadow-2xl transform translate-y-full transition-transform duration-300 flex flex-col max-h-[90vh]" id="bkashModalContent">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">বিকাশ-নগদ ট্র্যাকার</h3>
                <button id="btnBkashClose" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="space-y-3 mb-6">
                <div class="grid grid-cols-2 gap-2">
                    <select id="bkashMethod" class="p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 rounded-xl focus:outline-none text-sm font-semibold">
                        <option value="bKash">বিকাশ</option>
                        <option value="Nagad">নগদ</option>
                    </select>
                    <select id="bkashType" class="p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 rounded-xl focus:outline-none text-sm font-semibold">
                        <option value="টাকা পাঠানো">টাকা পাঠানো (ক্যাশ জমা)</option>
                        <option value="রিয়াল আনা">রিয়াল আনা (ক্যাশ খরচ)</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="bkashAmt" placeholder="টাকার পরিমাণ" class="flex-1 p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 rounded-xl focus:outline-none">
                    <button id="btnBkashAdd" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold">যোগ</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto transaction-list space-y-2" id="bkashList"></div>
        </div>
    </div>

    <!-- ডেইলি ক্যাশ মডাল -->
    <div id="cashModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-end justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-t-[32px] p-6 shadow-2xl transform translate-y-full transition-transform duration-300" id="cashModalContent">
            <h3 class="text-xl font-bold mb-6">ডেইলি ক্যাশ আপডেট</h3>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <label class="block text-xs font-bold opacity-50 uppercase mb-1">ওপেনিং ক্যাশ (সকালের গাল্লা)</label>
                    <input type="number" id="openingCash" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 rounded-2xl focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold opacity-50 uppercase mb-1">ক্লোজিং ক্যাশ (রাতের গাল্লা)</label>
                    <input type="number" id="closingCash" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 rounded-2xl focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-orange-500 uppercase mb-1">মনদুভ বিল (ক্যাশ খরচ)</label>
                    <input type="number" id="mandubInput" class="w-full p-4 bg-orange-50 dark:bg-slate-700 border border-orange-200 rounded-2xl focus:outline-none">
                </div>
                <div class="flex gap-3 pt-4 pb-2">
                    <button id="btnCashCancel" class="flex-1 py-4 bg-slate-100 dark:bg-slate-700 font-bold rounded-2xl">বন্ধ</button>
                    <button id="btnCashSave" class="flex-[2] py-4 bg-blue-600 text-white font-bold rounded-2xl">সেভ</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, serverTimestamp, set, remove, off } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
            databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "exchange-project-d4028",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const banglaMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
        const banglaDigits = {'0':'০','1':'১','2':'২','3':'৩','4':'৪','5':'৫','6':'৬','7':'৭','8':'৮','9':'৯'};

        const toBangla = (num) => num.toString().split('').map(d => banglaDigits[d] || d).join('');

        // বর্তমান অবস্থা
        let now = new Date();
        let currentS = { d: now.getDate(), m: now.getMonth(), y: now.getFullYear() };
        let activeListeners = [];

        // UI Helpers
        const toggleModal = (modal, show) => {
            if(show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        };

        const animateModal = (modal, content, show) => {
            if(show) { modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('translate-y-full'), 10); }
            else { content.classList.add('translate-y-full'); setTimeout(() => modal.classList.add('hidden'), 300); }
        };

        const updateFilterUI = () => {
            document.getElementById('valDay').innerText = toBangla(currentS.d);
            document.getElementById('valMonth').innerText = banglaMonths[currentS.m];
            document.getElementById('valYear').innerText = toBangla(currentS.y);
            
            const fullDateStr = `${toBangla(currentS.d)} ${banglaMonths[currentS.m]} ${toBangla(currentS.y)}`;
            document.getElementById('currentDateDisp').innerText = fullDateStr;
            
            refreshData();
        };

        const getDateKey = () => `${currentS.y}-${String(currentS.m + 1).padStart(2, '0')}-${String(currentS.d).padStart(2, '0')}`;

        const refreshData = () => {
            activeListeners.forEach(l => off(l.ref));
            activeListeners = [];

            const dateKey = getDateKey();
            const cashRef = ref(db, `daily_records/${dateKey}/cash`);
            const bkTransRef = ref(db, `daily_records/${dateKey}/bkash_transactions`);

            const cashL = onValue(cashRef, (snap) => {
                const data = snap.val() || {};
                const op = data.opening || 0;
                const cl = data.closing || 0;
                const md = data.mandub || 0;
                const bk_in = data.bk_in || 0;
                const bk_out = data.bk_out || 0;

                document.getElementById('dispOpening').innerText = `৳ ${op}`;
                document.getElementById('dispClosing').innerText = `৳ ${cl}`;
                document.getElementById('dispMandub').innerText = `৳ ${md}`;
                document.getElementById('dispBkash').innerText = `৳ ${bk_in - bk_out}`;
                document.getElementById('bkashDetail').innerText = `পাঠানো (ক্যাশ +): ${bk_in} | আনা (ক্যাশ -): ${bk_out}`;
                
                const netSale = (cl + md + bk_out) - (op + bk_in);
                document.getElementById('topNetProfit').innerText = `৳ ${netSale}`;
                document.getElementById('productSaleOnly').innerText = `৳ ${netSale}`;
                document.getElementById('totalBalance').innerText = `৳ ${cl}`;
                
                document.getElementById('openingCash').value = op;
                document.getElementById('closingCash').value = cl;
                document.getElementById('mandubInput').value = md;
            });
            activeListeners.push({ ref: cashRef });

            const bkL = onValue(bkTransRef, (snap) => {
                const listDiv = document.getElementById('bkashList');
                const data = snap.val();
                listDiv.innerHTML = "";
                let inT = 0; let outT = 0;

                if(!data) {
                    listDiv.innerHTML = '<p class="text-center text-slate-400 py-10">লেনদেন নেই</p>';
                    set(ref(db, `daily_records/${dateKey}/cash/bk_in`), 0);
                    set(ref(db, `daily_records/${dateKey}/cash/bk_out`), 0);
                    return;
                }

                Object.entries(data).reverse().forEach(([key, val]) => {
                    if(val.type === "টাকা পাঠানো") inT += val.amount;
                    else if(val.type === "রিয়াল আনা") outT += val.amount;

                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700";
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold ${val.method === 'bKash' ? 'bg-pink-100 text-pink-600' : 'bg-orange-100 text-orange-600'}">${val.method === 'bKash' ? 'Bk' : 'Ng'}</div>
                            <div><div class="text-xs font-bold">${val.type}</div><div class="text-[9px] opacity-40">${val.method}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <strong class="text-sm">৳ ${val.amount}</strong>
                            <button class="text-rose-400 del-btn" data-id="${key}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>`;
                    listDiv.appendChild(item);
                });

                document.querySelectorAll('.del-btn').forEach(b => b.onclick = () => {
                    if(confirm('ডিলিট করতে চান?')) remove(ref(db, `daily_records/${dateKey}/bkash_transactions/${b.dataset.id}`));
                });

                set(ref(db, `daily_records/${dateKey}/cash/bk_in`), inT);
                set(ref(db, `daily_records/${dateKey}/cash/bk_out`), outT);
            });
            activeListeners.push({ ref: bkTransRef });
        };

        const showPicker = (type) => {
            const grid = document.getElementById('pickerGrid');
            grid.innerHTML = "";
            let title = "";
            
            if(type === 'day') {
                title = "দিন সিলেক্ট করুন";
                for(let i=1; i<=31; i++) {
                    const btn = document.createElement('div'); btn.className = "picker-item"; btn.innerText = toBangla(i);
                    btn.onclick = () => { currentS.d = i; updateFilterUI(); toggleModal(document.getElementById('pickerModal'), false); };
                    grid.appendChild(btn);
                }
            } else if(type === 'month') {
                title = "মাস সিলেক্ট করুন";
                banglaMonths.forEach((m, idx) => {
                    const btn = document.createElement('div'); btn.className = "picker-item"; btn.innerText = m;
                    btn.onclick = () => { currentS.m = idx; updateFilterUI(); toggleModal(document.getElementById('pickerModal'), false); };
                    grid.appendChild(btn);
                });
            } else if(type === 'year') {
                title = "বছর সিলেক্ট করুন";
                for(let i=2024; i<=2030; i++) {
                    const btn = document.createElement('div'); btn.className = "picker-item"; btn.innerText = toBangla(i);
                    btn.onclick = () => { currentS.y = i; updateFilterUI(); toggleModal(document.getElementById('pickerModal'), false); };
                    grid.appendChild(btn);
                }
            }
            document.getElementById('pickerTitle').innerText = title;
            toggleModal(document.getElementById('pickerModal'), true);
        };

        // ইভেন্ট লিসেনারস
        document.getElementById('boxDay').onclick = () => showPicker('day');
        document.getElementById('boxMonth').onclick = () => showPicker('month');
        document.getElementById('boxYear').onclick = () => showPicker('year');
        document.getElementById('closePicker').onclick = () => toggleModal(document.getElementById('pickerModal'), false);

        // "আজ" বাটনের লজিক
        document.getElementById('boxToday').onclick = () => {
            let today = new Date();
            currentS = { d: today.getDate(), m: today.getMonth(), y: today.getFullYear() };
            updateFilterUI();
        };

        document.getElementById('btnCashCalc').onclick = () => animateModal(document.getElementById('cashModal'), document.getElementById('cashModalContent'), true);
        document.getElementById('btnCashCancel').onclick = () => animateModal(document.getElementById('cashModal'), document.getElementById('cashModalContent'), false);
        document.getElementById('bkashCard').onclick = () => animateModal(document.getElementById('bkashModal'), document.getElementById('bkashModalContent'), true);
        document.getElementById('btnBkashClose').onclick = () => animateModal(document.getElementById('bkashModal'), document.getElementById('bkashModalContent'), false);

        document.getElementById('btnCashSave').onclick = async () => {
            const dateKey = getDateKey();
            const op = parseFloat(document.getElementById('openingCash').value) || 0;
            const cl = parseFloat(document.getElementById('closingCash').value) || 0;
            const md = parseFloat(document.getElementById('mandubInput').value) || 0;
            await set(ref(db, `daily_records/${dateKey}/cash/opening`), op);
            await set(ref(db, `daily_records/${dateKey}/cash/closing`), cl);
            await set(ref(db, `daily_records/${dateKey}/cash/mandub`), md);
            animateModal(document.getElementById('cashModal'), document.getElementById('cashModalContent'), false);
        };

        document.getElementById('btnBkashAdd').onclick = async () => {
            const dateKey = getDateKey();
            const amt = parseFloat(document.getElementById('bkashAmt').value);
            if(!amt || amt <= 0) return;
            await push(ref(db, `daily_records/${dateKey}/bkash_transactions`), {
                method: document.getElementById('bkashMethod').value,
                type: document.getElementById('bkashType').value,
                amount: amt,
                timestamp: serverTimestamp()
            });
            document.getElementById('bkashAmt').value = "";
        };

        document.getElementById('btnTheme').onclick = () => {
            document.body.classList.toggle('dark-theme');
            document.getElementById('sunIcon').classList.toggle('hidden');
            document.getElementById('moonIcon').classList.toggle('hidden');
        };

        document.getElementById('btnExport').onclick = () => {
            html2canvas(document.getElementById('captureArea')).then(canvas => {
                const link = document.createElement('a'); link.download = `report_${getDateKey()}.png`; link.href = canvas.toDataURL(); link.click();
            });
        };

        updateFilterUI();

    </script>
</body>
</html>

